\documentclass[12pt,a4paper]{article}

\usepackage[margin=1in]{geometry}
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{booktabs}
\usepackage{hyperref}
\usepackage{xcolor}
\usepackage{float}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{enumitem}

\hypersetup{
    colorlinks=true,
    linkcolor=blue,
    citecolor=blue,
    urlcolor=blue
}

\title{\textbf{Futures Roll Analysis Framework}\\Copper (HG) Case Study 2008--2024}
\author{}
\date{}

\begin{document}

\maketitle

\begin{abstract}
I present a unified Python framework for detecting institutional roll activity in futures markets. Minute-level CME copper (HG) contracts (2008--2024) are ingested, aggregated into variable-granularity buckets, and analysed using a vectorised calendar-spread detection engine. The refactored codebase introduces a conventional \texttt{src/} package layout, reusable services, and command-line entry points that reproduce key empirical findings: 2{,}736 hourly roll events (6.16\% hit-rate) with a median timing of 28 days before expiry, and 183 daily events after contract-quality filtering with a 14-day median lead.
\end{abstract}



\section{Framework Overview}

\subsection{Objectives}
\begin{itemize}[noitemsep]
    \item Provide a reproducible pipeline for futures roll-detection research.
    \item Standardise data ingest, aggregation, panel assembly, and event detection across commodities.
    \item Surface empirical roll statistics (timing, session distribution, liquidity confirmation).
\end{itemize}

\subsection{Repository Layout}
\begin{verbatim}
src/futures_roll_analysis/
  analysis.py        # hourly & daily orchestration services
  buckets.py         # 10-session schema and aggregation helpers
  ingest.py          # minute-file discovery and contract aggregation
  panel.py           # wide panel assembly with expiry metadata
  rolls.py           # vectorised front/next, spreads, liquidity signals
  events.py          # spread-widening detection & summaries
  quality.py         # data-quality filtering and reporting utilities
  cli/               # command-line entry points (hourly, daily, organise)
\end{verbatim}

\paragraph{Configuration and metadata}
\begin{itemize}[noitemsep]
    \item \texttt{config/settings.yaml}: Source-of-truth for commodity root, timezone, bucket detection parameters, and quality thresholds.
    \item \texttt{metadata/contracts\_metadata.csv}: Official CME expiry dates used for front/next identification.
\end{itemize}

\paragraph{Outputs}
\begin{itemize}[noitemsep]
    \item \texttt{outputs/panels/}: Parquet \& CSV panels (hourly and filtered daily).
    \item \texttt{outputs/roll\_signals/}: Spread, widening, and liquidity series.
    \item \texttt{outputs/analysis/}: Summary tables (bucket distribution, preference scores, transition matrix, daily widening summary).
    \item \texttt{outputs/data\_quality/}: Contract-level metrics and JSON summary produced during daily runs with filtering enabled.
\end{itemize}

\section{Data Preparation}

\subsection{Source and Scope}
\begin{itemize}[noitemsep]
    \item Exchange: CME Group copper (HG) futures.
    \item Horizon: January 2008â€“December 2024 (202 listed contracts).
    \item Frequency: 1-minute OHLCV with optional open-interest fields.
    \item Files: 13{,}548 source files spanning 32 commodities, organised into 32 folders via the CLI organiser.
    \item Timezone: US/Central (Chicago).
\end{itemize}

\subsection{Organising Raw Data}
Raw \texttt{*.txt} files are placed under asset-specific directories via:
\begin{verbatim}
python -m futures_roll_analysis.cli.organize \
  --source /path/to/raw_txt \
  --destination organized_data
\end{verbatim}
The organiser recognises contract symbols, creates commodity folders, and writes \texttt{data\_inventory.csv}.

\subsection{Data Filtering}
\begin{itemize}[noitemsep]
    \item Contracts failing minimum density, coverage, or gap constraints are excluded.
    \item Thresholds configurable in \texttt{settings.yaml} (default: 500 data points, coverage $\geq$25\%, max gap 30 days, cutoff year 2015).
    \item Reports saved as CSV and JSON in \texttt{outputs/data\_quality}.
\end{itemize}
\section{Methodology}

\subsection{Minute Aggregation to Buckets}
\begin{enumerate}[label=\arabic*., itemsep=3pt]
    \item Localise/convert minute timestamps to US/Central.
    \item Assign each minute to one of 10 sessions (7 one-hour US periods, plus Late US, Asia, Europe).
    \item Anchor buckets by start timestamp (e.g., Asia session begins 21:00 of prior day).
    \item Aggregate OHLCV per bucket (open=first, close=last, high=max, low=min, volume=sum).
\end{enumerate}
Vectorised helpers in \texttt{buckets.py} avoid per-row Python loops; validation utilities ensure volume/price conservation.

\subsection{Panel Assembly}
\begin{itemize}[noitemsep]
    \item Each contract receives a dedicated column block (open, high, low, close, volume, expiry metadata).
    \item Metadata bucket columns are merged into a single \texttt{meta} namespace to avoid duplication.
    \item Expiry dates are sourced from CME metadata and normalised to midnight.
\end{itemize}

\subsection{Front/Next Identification and Spread Calculation}
\begin{itemize}[noitemsep]
    \item \texttt{rolls.identify\_front\_next}: vectorised computation using expiry arrays and \texttt{numpy.argmin}.
    \item Active contracts require: (a) finite price, (b) expiry date $\geq$ observation date.
    \item Spread = next close $-$ front close; liquidity roll = next volume $\geq \alpha \cdot$ front volume (default $\alpha=0.8$).
\end{itemize}

\subsection{Spread-Widening Detection}
\begin{itemize}[noitemsep]
    \item Change series: $\Delta s_t = s_t - s_{t-1}$.
    \item Z-score window: 20 buckets (approx.\ 2 trading days) for hourly pipeline; 30 days for daily pipeline.
    \item Threshold: $z > 1.5$ plus optional absolute floor (unused by default).
    \item Cool-down: 3-hour time delta for buckets or configurable integer window for daily analysis.
    \item Outputs: boolean widening series, bucket-level summaries, preference scores (event rate vs.\ volume share), transition matrix.
\end{itemize}



\section{Empirical Results (HG)}

\subsection{Hourly Bucket Insights}
\begin{itemize}[noitemsep]
    \item Total buckets: 44{,}428 (2008--2024).
    \item Widening events detected: 2{,}736 (frequency 6.16\%).
    \item Median timing: 28 days before expiry (IQR 16--43, range 0--116).
\end{itemize}

\begin{table}[H]
    \centering
    \caption{Roll Events by Intraday Period (2008--2024)}
    \begin{tabular}{llrrr}
        \toprule
        Bucket & Session Label & Events & Share (\%) & Pref.\ Score \\
        \midrule
        1 & 09:00 -- US Open & 383 & 14.00 & 1.04 \\
        2 & 10:00 -- US Morning & 284 & 10.38 & 0.73 \\
        3 & 11:00 -- US Late Morning & 238 & 8.70 & 0.70 \\
        4 & 12:00 -- US Midday & 186 & 6.80 & 0.60 \\
        5 & 13:00 -- US Early Afternoon & 132 & 4.82 & 0.87 \\
        6 & 14:00 -- US Late Afternoon & 198 & 7.24 & \textbf{2.18} \\
        7 & 15:00 -- US Close & 151 & 5.48 & \textbf{2.02} \\
        8 & Late US / After-Hours & 296 & 10.78 & 0.87 \\
        9 & Asia Session & 454 & 16.67 & 0.47 \\
        10 & Europe Session & 414 & 15.13 & 0.51 \\
        \bottomrule
    \end{tabular}
    \label{tab:bucket-summary}
\end{table}

\paragraph{Observation}
US regular hours account for 57.4\% of events despite fewer minutes per day and dominate the preference scores---late afternoon and close sessions exhibit more than twice the expected activity based on volume share, highlighting concentrated institutional rolling near settlement.

\subsection{Daily Panel Validation}
\begin{itemize}[noitemsep]
    \item Contracts analysed after filtering: 109 (out of 202).
    \item Valid spread observations: 3{,}309 across 5{,}105 trading days.
    \item Widening events detected: 183 (3.6\% hit-rate).
    \item Median days-to-expiry: 14 (mean 24.0, range 0--352); daily view emphasises late rollers once sparse contracts are excluded.
    \item Liquidity rolls (volume-based) confirm 64\% of spread signals.
\end{itemize}

\section{Usage Guide}

\subsection{Installation}
\begin{verbatim}
python -m pip install --upgrade pip
python -m pip install -e .[dev,viz]
\end{verbatim}
The editable install exposes console scripts:
\begin{itemize}[noitemsep]
    \item \texttt{futures-roll-organize}
    \item \texttt{futures-roll-hourly}
    \item \texttt{futures-roll-daily}
\end{itemize}

\subsection{Hourly Analysis}
\begin{verbatim}
futures-roll-hourly \
  --settings config/settings.yaml \
  --root organized_data/copper \
  --output-dir outputs
\end{verbatim}
Optional flags: \texttt{--metadata}, \texttt{--max-files}, \texttt{--log-level}.

\subsection{Daily Analysis}
\begin{verbatim}
futures-roll-daily \
  --settings config/settings.yaml \
  --root organized_data/copper \
  --output-dir outputs
\end{verbatim}

\subsection{Testing}
\begin{verbatim}
pytest
\end{verbatim}
Unit tests cover bucket assignment/aggregation, Z-score detection, and cool-down behaviour.

\section{Conclusion and Future Work}

\subsection{Key Takeaways}
\begin{itemize}[noitemsep]
    \item Refactored architecture cleanly separates ingest, aggregation, event detection, and CLI orchestration.
    \item Hourly analytics reveal heterogeneous roll behaviour, with statistically significant clustering during 14:00--15:00 CT.
    \item Daily validation (with quality filters) confirms persistent signals and highlights the importance of contract selection.
\end{itemize}


\end{document}
